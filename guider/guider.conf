# Guider Configuration

'''
[ Threshold Description ]

- RESOURCE
    - cpu
    - gpu
    - mem
    - gpumem
    - swap
    - block
    - storage
    - net
    - fd
    - file
    - task

- TARGET
    - SYSTEM: system resources
    - TASK:   task resources (except for Guider)
    - DEVICE: device resources
    - NAME:   specific task, device, event

- FIELD
    < common >
    - apply:    activation value (true/false)
    - perm:     permission requirement (root)
    - interval: duration condition for event (tick)
    - taskmon:  monitoring status for tasks (true/false)
    - message:  event message (string)
    - explain:  description (string)
    - command:  command set for event handling
    - oneshot:  one-time event handling value (true/false)
    - refresh:  restart timer for items disabled by oneshot (tick)
    - goneshot: global oneshot value (true/false)
    - lock:     global lock value to handle the event exclusively (true/false)
    - before:   uptime condition
    - after:    uptime condition

    < cpu | gpu >
    - total: CPU/GPU usage for system/process/thread (%)

    < mem >
    - available: system available memory (MB)
    - rss:       process Resident Set Size (MB)

    < gpumem >
    - total: system RAM usage for GPU (MB)
    - size:  per-process RAM usage for GPU (MB)

    < swap >
    - usagePer: system swap usage (%)
    - swapOut:  process swap-outed memory (MB)

    < block >
    - ioWait: system wait time for I/O (%)
    - read:   process read size
    - write:  process write size

    < storage >
    - usagePer: system storage usage (%)

    < net >
    - inbound:  system RX size
    - outbound: system TX size
    - recv:     device RX size
    - trans:    device TX size

    < fd >
    - curfd:  file handle number for system
    - fdsize: file descriptor number for process

    < file >
    - big:   file size
    - less:  file size
    - exist: file status (true/false)
    - none:  file status (true/false)

    < task >
    - nrCtx:    context switching number for system/thread
    - new:      created task status (true/false)
    - die:      terminated task status (true/false)
    - abnormal: abnormal task status (true/false)

- VARIABLE
    - EVTNAME: event name
    - EVTTIME: event time
    - EVTPID:  task PID
    - SELFPID: Guider PID

- COMMAND (embedded)
    - BUFFER{:SIZE}:      resize the monitoring buffer
    - CLEAR:              clear the monitoring buffer
    - DISABLE{:RESOURCE}: disable monitoring of the specific resource
    - ENABLE{:RESOURCE}:  enable monitoring of the specific resource
    - INTERVAL{:TIME}:    change the monitoring interval
    - PAUSE:              pause all monitoring activities
    - RELOAD:             reload the threshold config
    - RESTART:            restart the process
    - SAVE{:TIME@NAME}:   save the monitoring results to the file from the past to some time thereafter
    - STOP:               stop the threshold monitoring

- CHARACTER
    - #: ignore a line
    - ''': ignore specific range
'''

<threshold>
{

    "COMMAND": {

        "CMD_NOTIFY_WARN": "GUIDER cli upstream:notify:WARN",
        "CMD_TOP": "GUIDER top -o /tmp/guider_top_EVTNAME_EVTTIME.out -R 10 -Y c:15",
        "CMD_FTOP": "GUIDER ftop -o /tmp/guider_top_EVTNAME_EVTTIME.out -a -R 1 -Y c:15",
        "CMD_FTOP_PROC": "GUIDER ftop -o /tmp/guider_top_EVTNAME_EVTTIME.out -a -g EVTPID -R 1 -Y c:15",
        "CMD_MTOP": "GUIDER mtop -o /tmp/guider_top_EVTNAME_EVTTIME.out -R 3 -Y c:15",
        "CMD_FUNCREC": "GUIDER funcrec -s /tmp/guider_funcrec_EVTNAME_EVTTIME.dat -R 3",
        "CMD_DISKTOP": "GUIDER disktop -R 3 -a -o /tmp/guider_block_EVTNAME_EVTTIME.out -Y c:15",
        "CMD_DISKTOP_TOTAL": "GUIDER disktop -e T -R 3 -a -o /tmp/block_EVTNAME_EVTTIME.out -Y c:15",
        "CMD_NETTOP": "GUIDER ntop -R 3 -o /tmp/guider_task_EVTNAME_EVTTIME.out -Y c:15",
        "CMD_TTOP_CTX": "GUIDER ttop -S C:1 -R 2 -o /tmp/guider_task_EVTNAME_EVTTIME.out -Y c:15",
        "CMD_TTOP_UTOP": "GUIDER ttop -g EVTPID -P -S c:1 -e E -R 1 -Q -c \"GUIDER utop -g PID -H -o /tmp/guider_utop_EVTNAME_EVTTIME_COMM_PID.out -R 3\"",
        "CMD_UTOP": "GUIDER utop -g PID -H -o /tmp/guider_utop_EVTNAME_EVTTIME_COMM_PID.out -R 3",
        "CMD_LEAK_1G": "GUIDER leaktrace -g EVTPID -T /tmp/libleaktracer.so -o /tmp/guider_leak_EVTNAME_EVTTIME.out -c 1g",
        "CMD_LEAK_+200M": "GUIDER leaktrace -g EVTPID -T /tmp/libleaktracer.so -o /tmp/guider_leak_EVTNAME_EVTTIME.out -c +200m"

    },

    "cpu": {

        "SYSTEM": [
            {
                "apply": "true",
                "total": 95,
                "interval": 5,
                "after": "60s",
                "taskmon": "true",
                "oneshot": "true",
                "refresh": 10,
                "command": ["SAVE:5s"],
                "message": "system CPU usage is high",
                "explain": "save monitoring results until after 5 seconds"
            },

            {
                "apply": "false",
                "total": 99,
                "interval": 5,
                "perm": "root",
                "lock": "true",
                "command": ["CMD_TOP", "CMD_FUNCREC"],
                "message": "system CPU usage is critical",
                "explain": "monitor processes and trace functions for specific time"
            }
        ],

        "TASK": [
            {
                "apply": "false",
                "total": 95,
                "interval": 5,
                "oneshot": "true",
                "refresh": 30,
                "lock": "true",
                "perm": "root",
                "except": ["b.out"],
                "command": ["CMD_TTOP_UTOP"],
                "explain": "trace functions for threads using CPU in specific processes"
            }
        ],

        "yes": [
            {
                "apply": "false",
                "total": 98,
                "interval": 3,
                "perm": "root",
                "lock": "true",
                "oneshot": "true",
                "command": ["CMD_TTOP_UTOP"],
                "explain": "trace functions for threads using CPU in specific processes"
            }
        ]

    },

    "gpu": {

        "DEVICE": {
            "apply": "false",
            "total": 95,
            "interval": 10,
            "taskmon": "true",
            "command": ["SAVE:5s"],
            "message": "system GPU usage is high",
            "explain": "save monitoring results until after 5 seconds"
        }

    },

    "mem": {

        "SYSTEM": {
            "apply": "true",
            "available": 100,
            "goneshot": "true",
            "command": ["CMD_MTOP"],
            "message": "system available memory is low"
        },

        "TASK": {
            "apply": "false",
            "rss": 800,
            "perm": "root",
            "oneshot": "true",
	    "lock": "true",
            "except": ["b.out"],
            "command": ["CMD_LEAK_1G"],
            "explain": "trace functions for specific processes consuming memory"
        },

        "a.out": {
            "apply": "false",
            "rss": 10,
            "interval": 3,
            "perm": "root",
            "oneshot": "true",
	    "lock": "true",
            "command": ["CMD_LEAK_+200M"],
            "explain": "trace functions for specific processes consuming memory"
        }

    },

    "gpumem": {

        "SYSTEM": {
            "apply": "false",
            "total": 2048,
            "oneshot": "true",
            "command": ["CMD_MTOP"],
            "message": "GPU memory usage is high"
        },

        "TASK": {
            "apply": "false",
            "size": 310,
            "perm": "root",
            "oneshot": "true",
            "except": ["b.out"],
            "command": ["SAVE:3s"],
            "message": "GPU memory usage for the specific process is high"
        },

        "weston": {
            "apply": "false",
            "size": 500,
            "perm": "root",
            "oneshot": "true",
            "command": ["SAVE:3s"],
            "message": "GPU memory usage for the specific process is high"
        }

    },

    "swap": {

        "SYSTEM": {
            "apply": "false",
            "usagePer": 95,
            "interval": 5,
            "perm": "root",
            "command": ["CMD_MTOP"],
            "message": "system SWAP usage is high",
            "explain": "trace system memory usage"
        },

        "TASK": {
            "apply": "false",
            "swap": 100,
            "except": ["b.out"],
            "command": ["CMD_MTOP"],
            "explain": "trace task memory usage"
        }

    },

    "block": {

        "SYSTEM": {
            "apply": "false",
            "ioWait": 10,
            "interval": 5,
            "perm": "root",
            "command": ["CMD_DISKTOP"],
            "message": "system I/O is heavy",
            "explain": "trace system storage usage"
        },

        "TASK": {
            "apply": "false",
            "read": "500M",
            "write": "100M",
            "perm": "root",
            "interval": 2,
            "except": ["b.out"],
            "command": ["CMD_DISKTOP_TOTAL"],
            "explain": "trace task I/O"
        },

        "a.out": {
            "apply": "false",
            "read": "500M",
            "write": "100M",
            "interval": 2,
            "perm": "root",
            "command": ["CMD_DISKTOP_TOTAL"],
            "explain": "trace task I/O"
        }

    },

    "storage": {

        "SYSTEM": {
            "apply": "false",
            "usagePer": 95,
            "oneshot": "true",
            "perm": "root",
            "command": ["CMD_DISKTOP"],
            "message": "system storage usage is high",
            "explain": "trace system storage usage"
        },

        "DEVICE": {
            "apply": "false",
            "usagePer": 99,
            "interval": 5,
            "except": ["/dev/loop*"],
            "perm": "root",
            "oneshot": "true",
            "command": ["CMD_DISKTOP"],
            "explain": "trace storage usage for all devices"
        },

        "/dev/sda2": {
            "apply": "false",
            "usagePer": 99,
            "perm": "root",
            "oneshot": "true",
            "command": ["CMD_DISKTOP"],
            "explain": "trace storage usage for the specific device"
        }

    },

    "net": {

        "SYSTEM": {
            "apply": "false",
            "inbound": "1G",
            "outbound": "500M",
            "interval": 3,
            "perm": "root",
            "command": ["CMD_NETTOP"],
            "message": "system network usage is high",
            "explain": "trace network usage for all devices"
        },

        "DEVICE": {
            "apply": "false",
            "recv": "1G",
            "trans": "500M",
            "interval": 3,
            "except": ["lo"],
            "perm": "root",
            "command": ["CMD_NETTOP"],
            "explain": "trace network usage for specific devices"
        },

        "enp7s0": {
            "apply": "false",
            "recv": "1G",
            "trans": "1G",
            "perm": "root",
            "interval": 3,
            "command": ["CMD_NETTOP"],
            "explain": "trace network usage for the specific device"
        }

    },

    "fd": {

        "SYSTEM": {
            "apply": "false",
            "curfd": 90000,
            "perm": "root",
            "oneshot": "true",
            "command": ["CMD_FTOP"],
            "explain": "monitor file descriptor info for all tasks"
        },

        "TASK": {
            "apply": "false",
            "fdsize": 10000,
            "perm": "root",
            "oneshot": "true",
            "refresh": 100,
            "command": ["CMD_FTOP_PROC"],
            "except": ["*.out", "screen"],
            "explain": "monitor file descriptor info for specific tasks"
        },

        "a.out": {
            "apply": "false",
            "fdsize": 10000,
            "perm": "root",
            "oneshot": "true",
            "command": ["CMD_FTOP_PROC"],
            "explain": "monitor file descriptor info for the specific task"
        }

    },

    "file": {

        "/tmp/PEACE*": {
            "apply": "false",
            "exist": "true",
            "perm": "root",
            "oneshot": "true",
            "command": ["SAVE"],
	    "explain": "save monitoring results"
        },

        "/tmp/OK": {
            "apply": "false",
            "none": "true",
            "perm": "root",
            "command": ["SAVE"],
	    "explain": "save monitoring results"
        },

        "/tmp/TEST": {
            "apply": "false",
            "big": "1M",
            "oneshot": "true",
            "perm": "root",
            "command": ["SAVE"],
	    "explain": "save monitoring results"
        },

        "/tmp/TEST2": {
            "apply": "false",
            "less": "1K",
            "oneshot": "true",
            "perm": "root",
            "command": ["SAVE"],
	    "explain": "save monitoring results"
        }

    },

    "task": {

        "SYSTEM": [
            {
                "apply": "false",
                "nrCtx": 50000,
                "command": ["CMD_TTOP_CTX"],
                "explain": "trace context switching for tasks"
            },

            {
                "apply": "false",
                "new": "true",
                "die": "true",
                "abnormal": "true",
                "command": ["CMD_TOP"],
                "explain": "trace processes"
            }
        ],

        "TASK": {
            "apply": "false",
            "except": ["b.out", "kworker*"],
            "nrCtx": 5000,
	    "command": ["SAVE:3s"],
	    "explain": "save monitoring results until after 5 seconds"
        },

        "a.out": {
            "apply": "false",
            "new": "true",
            "die": "true",
	    "command": ["SAVE"],
	    "explain": "save monitoring results until after 5 seconds"
        }

    }

}



'''
[ Server Description ]

- COMMAND: shortcut for commands

- INIT: commands executed remotely when connected
    - apply:    switch flag
    - perm:     requirement for permission
    - interval: interval for repeatation (TBD)
    - duration: condition for duration
    - command:  command set
    - oneshot:  oneshot flag (TBD)
    - explain:  description

- EVENT: event handlers
    - name:    event name
    - apply:   switch flag
    - command: commands executed when the event occur
    - handler: functions called when the event occur

- CHARACTER
    - #: ignore a line
    - ''': ignore specific range
'''

<server>
{
    "COMMAND": {

        "CMD_RTOP": "GUIDER rtop -Q -i 3 -C",
        "CMD_DOWN": "download:/tmp/*@./backup/",
        "CMD_MAIL": "mail -s \"Warning Report\" master@github.com"

    },

    "INIT": [

        {
            "apply": "false",
            "perm": "none",
            "oneshot": "true",
            "duration": "10s",
            "command": ["CMD_RTOP"],
            "explain": "print system stat in JSON format from the new node to stdout"
        },

        {
            "apply": "false",
            "perm": "none",
            "oneshot": "true",
            "command": ["CMD_RTOP->cat"],
            "explain": "deliver system stat in JSON format from the new node to the cat process in local machine through pipe"
        },

        {
            "apply": "false",
            "perm": "true",
            "oneshot": "false",
            "interval": "10s",
            "command": ["CMD_DOWN"],
            "explain": "download specific files from the new node every 10 seconds"
        }

    ],

    "EVENT": [

        {
            "name": "TEST",
            "apply": "false",
            "command": ["ls -lha", "CMD_MAIL"],
            "handler": ["./test.py:test"],
            "explain": "make a snapshot image for system"
        }

    ]
}



'''
[ Auto Command Description ]

- CHARACTER
    - #: ignore a line
    - ''': ignore specific range
'''

<command>
{
    "apply": "false",
    "list": [
        "GUIDER list",
        "ls -lha"
    ]
}
